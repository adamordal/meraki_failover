{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Parameters":{
       "vmx1":{
          "Type":"AWS::EC2::Instance::Id",
          "Default":"i-09ba434c1bEXAMPLE",
          "Description":"Enter vmx1 instance id"
       },
       "vmx2":{
          "Type":"AWS::EC2::Instance::Id",
          "Default":"i-09ba434c1bEXAMPLE",
          "Description":"Enter vmx2 instance id"
       },
       "RouteTableID":{
          "Type":"String",
          "Default":"rtb-09ba434c1bEXAMPLE",
          "Description":"Route table ID for table pointing towards VMX in security vpc."
       }
    },
    "Resources":{
       "vmx1alarm":{
          "Type":"AWS::CloudWatch::Alarm",
          "Properties":{
             "AlarmName":"vmx1-alarm-status",
             "Namespace":"AWS/EC2",
             "ComparisonOperator":"GreaterThanOrEqualToThreshold",
             "DatapointsToAlarm":1,
             "EvaluationPeriods":1,
             "MetricName":"StatusCheckFailed",
             "Period":60,
             "Statistic":"Average",
             "Dimensions":[
                {
                   "Name":"InstanceId",
                   "Value":{
                      "Ref":"vmx1"
                   }
                }
             ],
             "Threshold":0.99,
             "TreatMissingData": "breaching"
          }
       },
       "vmx2alarm":{
          "Type":"AWS::CloudWatch::Alarm",
          "Properties":{
             "AlarmName":"vmx2-alarm-status",
             "Namespace":"AWS/EC2",
             "ComparisonOperator":"GreaterThanOrEqualToThreshold",
             "DatapointsToAlarm":1,
             "EvaluationPeriods":1,
             "MetricName":"StatusCheckFailed",
             "Period":60,
             "Statistic":"Average",
             "Dimensions":[
                {
                   "Name":"InstanceId",
                   "Value":{
                      "Ref":"vmx2"
                   }
                }
             ],
             "Threshold":0.99,
             "TreatMissingData": "breaching"
          }
       },
       "EventBridgeLambdaPermission":{
            "Type": "AWS::Lambda::Permission",
            "Properties": {                   
                "FunctionName": {"Fn::GetAtt":[ "vmxfailover","Arn"]},
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {"Fn::GetAtt":[ "EventRule0","Arn"]}
            }
        },

       "EventRule0":{
          "Type":"AWS::Events::Rule",
          "Properties":{
             "EventBusName":"default",
             "EventPattern":{
                "source":[
                   "aws.cloudwatch"
                ],
                "detail-type":[
                   "CloudWatch Alarm State Change"
                ],
                "resources":[
                   {
                      "Fn::GetAtt":[
                         "vmx1alarm",
                         "Arn"
                      ]
                   },
                   {
                      "Fn::GetAtt":[
                         "vmx2alarm",
                         "Arn"
                      ]
                   }
                ]
             },
             "Name":"mvx-cfn-rule",
             "State":"ENABLED",
             "Targets":[
                {
                   "Id":"LambdaFunctionforVMX",
                   "Arn":{
                      "Fn::GetAtt":[
                         "vmxfailover",
                         "Arn"
                      ]
                   }
                }
             ]
          }
       },
       "vmxfailover":{
          "Type":"AWS::Lambda::Function",
          "Properties":{
             "FunctionName":"vmx-route-failover",
             "Handler":"index.lambda_handler",
             "Timeout": 30,
             "Role":{
                "Fn::GetAtt":[
                   "vmxfailoverLambdaRole",
                   "Arn"
                ]
             },
             "Code":{
                "S3Bucket":"aordal-lambda",
                "S3Key":"meraki_failover-master.zip"
             },
             "Runtime":"python3.10",
             "Environment":{
                "Variables":{
                   "vmx1":{
                      "Ref":"vmx1"
                   },
                   "vmx2":{
                      "Ref":"vmx2"
                   },
                   "region":{
                      "Ref":"AWS::Region"
                   },
                   "routetable":{
                      "Ref":"RouteTableID"
                   }
                }
             }
          }
       },
       "vmxfailoverLambdaRole":{
          "Type":"AWS::IAM::Role",
          "Properties":{
             "RoleName":"vmx-failover-LambdaRole",
             "AssumeRolePolicyDocument":{
                "Version":"2012-10-17",
                "Statement":[
                   {
                      "Effect":"Allow",
                      "Principal":{
                         "Service":[
                            "lambda.amazonaws.com"
                         ]
                      },
                      "Action":[
                         "sts:AssumeRole"
                      ]
                   }
                ]
             },
             "Path":"/",
             "Policies":[
                {
                   "PolicyName":"AWSLambdaBasicExecutionRole",
                   "PolicyDocument":{
                      "Version":"2012-10-17",
                      "Statement":[
                         {
                            "Effect":"Allow",
                            "Action":[
                               "logs:CreateLogGroup",
                               "logs:CreateLogStream",
                               "logs:PutLogEvents"
                            ],
                            "Resource":"*"
                         }
                      ]
                   }
                },
                {
                   "PolicyName":"AWSLambdaVMXFailoverRole",
                   "PolicyDocument":{
                      "Version":"2012-10-17",
                      "Statement":[
                         {
                            "Effect":"Allow",
                            "Action":[
                               "ec2:CreateRoute",
                               "ec2:DeleteRoute",
                               "ec2:ReplaceRoute",
                               "ec2:DescribeRouteTables",
                               "ec2:DescribeInstanceStatus"
                            ],
                            "Resource":{
                               "Fn::Sub":"arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:route-table/${RouteTableID}"
                            }
                         }
                      ]
                   }
                }
             ]
          }
       }
    }
 }